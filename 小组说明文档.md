# 飞马星球医院预约挂号微系统报告

## 1. 项目概览

- 模式：C/S 架构，客户端 JavaFX 桌面应用，服务端原生 Java Socket。
- 语言/构建：Java 17，Maven 多模块（client、server）。
- 传输协议：单行 JSON，消息以 `{"type":"...", "data":{...}}\n` 形式往返。
- 持久化：MySQL/MariaDB，初始化脚本见 `server/src/main/resources/init_habms.sql`。

## 2. 功能实现与要求对应

- 患者注册/登录/注销：账号信息校验，密码最少 4 位；注销会清理账户。
- 科室查询：从 department.json 加载，客户端展示下拉选择。
- 医生查询：按科室过滤，展示医生专长、排班。
- 预约挂号：选择医生与可预约时间段创建预约；同一时间段单人仅一号源，服务端事务扣减。
- 取消预约：仅在可取消状态下回补号源。
- 信息修改：患者可改除 ID/身份证号外的个人信息。
- 医生管理与排班：管理员导入、添加、更新、删除医生与排班。
- 批量导入：管理员可从 xls/csv 导入医生与排班（客户端工具入口）。
- 导出与报告：支持导出预约记录（xls）；月度统计报告生成 pdf（入口保留，格式可扩展）。
- 并发控制：预约流程数据库事务与同步锁，避免重复占号。

## 3. 系统架构与模块

- client 模块
  - App：JavaFX 启动/舞台管理。
  - Session：登录态持有（区分患者/医生）。
  - controller：登录、患者主页、医生主页、管理员页。
  - net/NetworkClient：TCP 长连接，行分隔 JSON。
  - service：AuthService（认证）、LookupService（查询）。
  - model：User/Doctor/Schedule/Appointment/Request/Response DTO。
  - resources：FXML 视图与 CSS。
- server 模块
  - ServerMain：读取端口/DB 环境变量后启动。
  - ServerRuntime：ServerSocket 循环接入。
  - Service：按 type 路由业务处理。
  - DepartmentLoader：加载科室列表。
  - db：HABMSDB（JDBC CRUD、业务事务）、实体/枚举（Account、DoctorAccount、Schedule、Appointment、AppointmentStatus、Sex、IdGenerator）。
  - resources：department.json、init_habms.sql。

## 4. 核心技术点

- UI：JavaFX + FXML + CSS，后台任务用 javafx.concurrent.Task，UI 更新用 Platform.runLater。
- 序列化：Jackson + JavaTimeModule。
- 网络：原生 Socket，单行 JSON。
- 数据库事务：
  - 预约：原子扣减号源→写预约，失败回滚。
  - 取消：仅 Ok→Abandon 回补号源。
- ID 生成：日期 + 随机（AID/DID/APID/SID）。
- 配置：环境变量 HABMS_PORT、HABMS_URL、HABMS_USER、HABMS_PASS、HABMS_DEPARTMENTS。
- 日志：java.util.logging。

## 5. 部署与运行

1) 准备数据库  

- 创建数据库 HABMSDB，执行 server/src/main/resources/init_habms.sql（或根目录 SQL）。

1) 启动服务端（在 server/）  

- mvnw exec:java -Dexec.mainClass=HABMS.server.ServerMain  
- 如需自定义：设置环境变量（端口/DB）。

1) 启动客户端（在 client/）  

- mvnw javafx:run  
- 默认连接 localhost:9000，可在 NetworkClient 中修改。

## 6. 数据模型（示意）

- 患者：pid(10)、name(≤20)、password(≥4)、idCard(18)、phone、sex(M/F)。
- 医生：did(8)、name、password、department(≤30)、specialty(≤200)、sex。
- 预约：apid(12)、pid、did、timeSlot(到分钟)、status(Ok/Abandon/Done)。
- 排班：sid、did、日期/时段、剩余号源。

## 7. 协议与主要接口（type）

- 账户：account_register / account_login / account_logout / account_update / account_delete
- 查询：department_list / doctor_query / schedule_by_doctor / schedule_by_time
- 预约：appointment_create / appointment_cancel / appointment_list
- 医生端：doctor_login / doctor_logout / doctor_schedules / doctor_appointments / doctor_call_next
- 管理：admin_add_schedules / admin_update_schedule / admin_add_doctors / admin_delete_doctor / admin_delete_schedule / admin_report

## 8. 并发与安全

- 并发：服务端多线程，每连接一线程；预约使用 DB 锁+事务；排班更新需与预约一致性检查。
- 安全：密码 SHA-256 传输但无加密，建议生产加 TLS；无速率限制/Token 过期机制，可按部署加固。

## 9. 测试与验证

- 数据库冒烟：执行 init 脚本后跑 server/src/test/java/HABMS/db/HABMSDBSmoke.java。
- 手工回归：登录/注册、查询科室医生、创建/取消预约、导入排班、导出预约。
- UI：核对 JavaFX 线程未阻塞；列表与表格刷新正确。

## 10. 交付物清单

- 源码：client、server 模块。
- 依赖：Maven 管理，含 JavaFX/Jackson/MySQL 驱动。
- SQL：init_habms.sql（含建表与样例数据）。
- 数据文件：datas/doctor.csv、schedule.csv（示例导入）。
- 文档：本报告（Markdown/PDF），可另附界面截图与分工说明。

## 11. 组内分工与权重

- 组长：34%（总体设计、服务端核心、协调交付）
- 组员A：33%（客户端 UI/网络、导入导出）
- 组员B：33%（数据库脚本、测试与文档）

## 12. 后续优化方向

- 引入 HTTP/REST + JWT，替换自定义 Socket 协议。
- 使用连接池与 ORM（JPA/MyBatis），增加分页/过滤。
- 完善表单校验、文件导入格式校验与错误提示。
- 增加限流/审计日志/指标监控；预约并发压测。
- 报表模板化，支持多维度统计与可视化。
