# 技术文档

## 总览

- 架构：典型 C/S 模式。服务端通过 TCP 套接字接受客户端请求，客户端以 JavaFX 构建桌面 UI。
- 语言/构建：Java 17（见 `pom.xml`），Maven 管理依赖并分为 `client` 与 `server` 两个模块。
- 传输协议：客户端与服务端使用“单行 JSON”协议，每条消息为 `{"type": "...", "data": {...}}`，以换行符分隔；服务端逐行解析并返回同样格式的响应。
- 数据库：服务端使用 MariaDB/MySQL（JDBC）作为持久层，表包括 `Account`、`Doctor`、`Schedule`、`Appointment` 等。初始建表/样例数据见根目录的 `create_stu_table.sql`、`insert_stu_data.sql` 及 `server/src/main/resources/init_habms.sql`。

## 代码结构

- `client/`
  - `App`：JavaFX 启动类，创建主舞台并加载登录页。
  - `Session`：简单登录态持有器，区分患者/医生会话。
  - `controller/`：UI 控制器。
    - `LoginController`：登录/注册交互，区分患者与医生入口；拉取科室列表。
    - `PatientMainController`：患者端主页，含科室/医生选择、排班展示、预约下单、预约列表、个人资料维护等。
    - `DoctorMainController`：医生端主页，展示个人排班与候诊预约；管理员视角增加导入、导出等管理入口。
    - `AdminMainController`：管理员工具页，批量导入医生与排班、查询/删除/修改医生及排班。
  - `model/`：客户端 DTO（`User`、`Doctor`、`Schedule`、`Appointment`、`Request`、`Response`）。
  - `net/NetworkClient`：TCP 长连接客户端，负责序列化/反序列化请求与响应。
  - `service/`：业务服务封装；`AuthService` 负责登录/注册，`LookupService` 负责只读查询。
  - `resources/HABMS/client`：FXML 视图与 CSS 皮肤。
- `server/`
  - `ServerMain`：读取环境变量/配置后启动 `ServerRuntime`。
  - `ServerRuntime`：简单的 `ServerSocket` 循环，接入连接即分派 `Service` 处理。
  - `Service`：单连接请求分发器，按 `type` 调用对应处理方法（登录、预约、排班、管理员操作等）。
  - `DepartmentLoader`：从 `department.json` 读取科室列表。
  - `db/`：数据库访问层
    - `HABMSDB`：封装 JDBC CRUD/业务事务（预约、排班变更、账号管理）。
    - 实体类/枚举：`Account`、`DoctorAccount`、`Schedule`、`Appointment`、`AppointmentStatus`、`Sex`、`IdGenerator`。
  - `resources`：`department.json`、`init_habms.sql`。

## 关键技术点

- **UI 技术**：JavaFX + FXML + CSS，使用 `TableView`、`ListView`、`ComboBox`、`Dialog` 等组件。
- **并发模型（客户端）**：所有网络调用封装为 `javafx.concurrent.Task`，在后台线程中执行，避免阻塞 UI 线程；回调中通过 `Platform.runLater` 更新界面。
- **网络协议**：基于原生 `Socket`，单行 JSON；服务端 `Service` 使用 Jackson 解析并按类型路由。
- **序列化**：Jackson `ObjectMapper`，注册 `JavaTimeModule` 以支持 `LocalDateTime`。
- **数据库事务**：
  - 预约流程 `TryAppointment` 使用手动事务：先原子扣减号源，再写入预约记录，失败即回滚。
  - 取消预约时，只有从 `Ok` -> `Abandon` 才返还号源。
- **ID 生成**：`IdGenerator` 使用日期 + 随机数生成 AID/DID/APID/SID，减少冲突。
- **日志与配置**：服务端使用 `java.util.logging`；端口/数据库连接信息可通过环境变量 `HABMS_PORT`、`HABMS_URL`、`HABMS_USER`、`HABMS_PASS`、`HABMS_DEPARTMENTS` 覆盖。

## 运行与构建

1. 数据库准备：创建 MariaDB/MySQL 数据库 `HABMSDB`，执行 `server/src/main/resources/init_habms.sql` 初始化表和初始数据。
2. 启动服务端：
   - 进入 `server/`，执行 `mvnw spring-boot:run` 或 `mvnw exec:java -Dexec.mainClass=HABMS.server.ServerMain`（项目使用原生 Java，未引入 Spring）。
   - 如需自定义端口/连接串，设置环境变量后再启动。
3. 启动客户端：
   - 进入 `client/`，执行 `mvnw javafx:run`（确保本机已安装 JavaFX 运行环境）。
4. 默认连接信息：客户端在 `NetworkClient` 中默认 `localhost:9000`。

## 协议与接口速览

- 请求示例：`{"type":"account_login","data":{"pid":"4101...","passwordHex":"<sha256>"}}`
- 响应示例：`{"Statu":"ok","data":{...}}`，失败时 `data.err_info` 描述错误。
- 主要 `type`：
  - 账户：`account_register`、`account_login`、`account_logout`、`account_update`、`account_delete`
  - 查询：`department_list`、`doctor_query`、`schedule_by_doctor`、`schedule_by_time`
  - 预约：`appointment_create`、`appointment_cancel`、`appointment_list`
  - 医生端：`doctor_login`、`doctor_logout`、`doctor_schedules`、`doctor_appointments`、`doctor_call_next`
  - 管理：`admin_add_schedules`、`admin_update_schedule`、`admin_add_doctors`、`admin_delete_doctor`、`admin_delete_schedule`、`admin_report`

## 安全与健壮性注意

- 客户端仅做最小校验，密码传输为 SHA-256 摘要但未加密，生产环境需增加 TLS。
- 服务端未做 IP/速率限制，也未实现 Token/会话超时，需按部署环境加固。
- CSV/Excel 导入（管理员端）依赖用户提供文件，当前未做格式校验与异常捕获完善。

## 后续优化方向

- 引入 HTTP/REST 接口与鉴权（如 JWT），替换自定义 TCP 协议。
- 客户端增加表单验证与错误提示国际化。
- 服务端增加分页/过滤、预约限流、日志追踪与监控指标。
- 使用 ORM（JPA/MyBatis）与连接池替换手写 JDBC，提高可维护性。
