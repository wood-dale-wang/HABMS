包名：HABMS.db

# 数据对象

这些类的一般初始化方法用于从数据库提取数据，create工厂方法用于创建带新ID的对象

## Account

用户账户对象

```java
String aid;             // 用户账户ID，需要保证长度为10
String name;            // 用户名字，最长20字符（中文也算一个）
String passwordHex;     // 密码SHA256值
String pid;             // 用户身份证ID，需要保证长度为18，（确定值后）不可变字段
String phone;           // 手机号，需要保证长度为11，（确定值后）不可变字段
Sex sex;                // 性别枚举：M,F
```

## DoctorAccount

医生账户对象

```java
String did;             // 用户账户ID，需要保证长度为8
String name;            // 用户名字，最长20字符（中文也算一个）
String passwordHex;     // 密码SHA256值
boolean admin;          // 是否为Admin账户，server模块应该保证仅Admin账户才可以修改排班表
String department;      // 部门，最长30字符
String description;     // 描述，最长200字符
```

## Schedule

排班对象

```java
int sid;                // 排班对象ID
String did;             // 排班关联的医生的DID，（确定值后）不可变字段
LocalDateTime startTime;// 开始时间，（确定值后）不可变字段
LocalDateTime endTime;  // 结束时间，（确定值后）不可变字段
int capacity;           // 容量
int res;                // 现在剩余（初始值等同于容量）
// 约束：同一医生的同一时间段（did,startTime,endTime）唯一
```

## Appointment

订单对象

```java
int serialNumber;           // 序列号，非空，（确定值后）不可变字段
String apid;                // 订单ID，需要保证长度为12
String aid;                 // 与其关联的用户的AID，（确定值后）不可变字段
String did;                 // 与其关联的医生的DID，（确定值后）不可变字段
int sid;                    // 与其关联的排班的SID，（确定值后）不可变字段
AppointmentStatus status;   // 状态枚举
LocalDateTime startTime;    // 开始时间（同SID对应的排班的时间），（确定值后）不可变字段
LocalDateTime endTime;      // 结束时间（同SID对应的排班的时间），（确定值后）不可变字段
```

# 数据库接口

## 对象

`HABMS.db.HABMSDB`

## 构建方法

`public HABMSDB(String url, String user, String password)`

## 方法

### 插入方法

+ `public void InsertAccount(Account account) throws SQLException`:
    插入一个用户账户对象数据（通过`Account`类）

+ `public void InsertDoctorAccount(DoctorAccount doctor) throws SQLException`:
    插入一个医生账户对象数据

+ `public void InsertAppointment(Appointment appointment) throws SQLException`:
    插入一个订单对象数据

+ `public void InsertSchedule(Schedule schedule) throws SQLException`:
    插入一个排班对象数据

+ `public void InsertSchedules(List<Schedule> schedules) throws SQLException`:
    插入多个排班对象数据

### 删除方法

+ `public void DelAccount(String aid) throws SQLException`:
    删除一个用户账户数据

+ `public void DelDoctorAccount(String did) throws SQLException`:
    删除一个医生账户数据

+ `public void DelAppointment(String apid) throws SQLException`:
    删除一个订单对象数据

+ `public void DelSchedule(int sid) throws SQLException`:
    删除一个排班对象数据

### 查询方法

+ `public Account FindAccount(String aid, String pid, String phone) throws SQLException`:
    通过AID/PID/Phone数据查询用户账户数据（只需要一个，其他传`null`即可）

+ `public DoctorAccount FindDoctorAccount(String did, String name) throws SQLException`:
    通过DID/Name数据查询医生账户数据（只需要一个，其他传`null`即可）

+ `public DoctorAccount[] FindDoctorAccounts(String department) throws SQLException`:
    通过Department（科室）数据查询多个医生账户数据

+ `public Appointment FindAppointment(String apid) throws SQLException`:
    通过APID查询订单数据

+ `public Appointment[] FindAppointmentBelongAccount(String aid) throws SQLException`:
    查询属于某个用户账户的订单数据（基于AID）

+ `public Appointment[] FindAppointmentBelongDoctorAccount(String did) throws SQLException`
    查询属于某个医生账户的订单数据（基于DID）

+ `public Appointment[] FindAppointmentBelongSchedule(int sid) throws SQLException`
    查询属于某个排班的订单数据（基于SID）

+ `public Appointment[] FindAppointmentByStatu(AppointmentStatus statu) throws SQLException`
    查询处于指定状态的订单数据

+ `public Schedule FindSchedule(int sid) throws SQLException`
    查询指定排班（通过SID）

+ `public Schedule[] FindScheduleBelongDoctorAccount(String did) throws SQLException`
    查询属于某个医生账户的排班数据（基于DID）

+ `public Schedule[] FindScheduleByTime(LocalDateTime time) throws SQLException`
    查询包含某个时间的排班数据

+ `public Schedule[] FindScheduleByTimeInDepartment(LocalDateTime time, String department) throws SQLException`
    查询包含某个时间且属于指定部门的排班数据

### 修改方法

+ `public void ChangeAccountInfo(Account account) throws SQLException`
    改变用户账户数据（传入改变后的用户账户对象）

+ `public void UpdateDoctorAccount(DoctorAccount doctor) throws SQLException`
    更新医生账户数据（传入改变后的医生账户对象，基于DID更新）

+ `public void ChangeAppointmentStatu(String apid, AppointmentStatus statu) throws SQLException`
    改变订单状态；当状态从Ok变为Abandon时，会为对应排班的Res加一

+ `public void ChangeScheduleCapacity(int sid, int delta) throws SQLException`
    修改排班容量数据，输入的是增量（原子操作）

+ `public Appointment TryAppointment(String aid, int sid) throws SQLException`
    尝试预定操作，成功返回预定数据对象，失败返回null（原子操作）

## 数据库初始化SQL脚本

`resources/init_habms.sql`
